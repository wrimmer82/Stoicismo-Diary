<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="google" content="notranslate">
    <title>Archivio Riflessioni - The Stoic Journey</title>
    <meta name="robots" content="noindex, nofollow">

    <script src="https://cdn.tailwindcss.com"></script>

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;600;700;900&family=Trajan+Pro:wght@400;700&family=Inter:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <style>
        .font-cinzel { font-family: 'Cinzel', serif; }
        .font-trajan { font-family: 'Trajan Pro', 'Cinzel', serif; }
        .font-inter  { font-family: 'Inter', sans-serif; }

        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(180deg, #1a0f1f 0%, #2d1b3d 10%, #4a2c4f 20%, #6b4a5a 35%, #8b5a4e 50%, #a8754a 65%, #c49050 80%, #a8754a 90%, #1c1410 100%);
            min-height: 100vh;
            background-attachment: fixed;
        }

        .parchment-card {
            background: rgba(245,222,179,0.95);
            border: 2px solid rgba(146,64,14,0.4);
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        }
        .parchment-card h3 { color: #92400e; text-shadow: 1px 1px 2px rgba(255,255,255,0.4); }
        .parchment-card label { color: #451a03; text-shadow: 0 1px 2px rgba(255,255,255,0.3); }

        .parchment-input {
            background: rgba(255,255,255,0.9);
            border: 2px solid rgba(146,64,14,0.3);
            color: #451a03;
        }
        .parchment-input:focus {
            border-color: #92400e;
            outline: none;
            box-shadow: 0 0 0 3px rgba(146,64,14,0.2);
        }

        .roman-number { font-family: 'Cinzel', serif; font-weight: 700; letter-spacing: 0.1em; }

        .nav-link { display: flex; align-items: center; gap: 0.75rem; padding: 0.75rem 1rem; border-radius: 0.5rem; transition: all 0.2s; }
        .nav-link:hover { background-color: rgba(30,41,59,1); }
        .nav-link.active { background-color: rgba(251,191,36,0.2); color: #fbbf24; font-weight: 500; }

        @keyframes pulse-glow {
            0%, 100% { box-shadow: 0 0 20px rgba(251,191,36,0.3); }
            50%       { box-shadow: 0 0 30px rgba(251,191,36,0.6); }
        }
        .streak-glow { animation: pulse-glow 2s ease-in-out infinite; }

        .lang-btn { transition: all 0.2s; }
        .lang-btn.active        { background-color:rgba(251,191,36,0.2); color:#fbbf24; border-color:#fbbf24; }
        .lang-btn:not(.active)  { color:#94a3b8; border-color:#334155; }
        .lang-btn:hover:not(.active) { border-color:#64748b; color:#cbd5e1; }

        @media (max-width: 767px) { .mobile-btn { min-height: 48px; font-size: 16px; } }
        @media (max-width: 360px) { .parchment-card p { font-size: 0.9rem; } }
    </style>
</head>
<body class="font-inter text-slate-100">

    <!-- HEADER -->
    <header class="sticky top-0 z-30 bg-slate-900/95 backdrop-blur-sm border-b border-amber-500/20 shadow-lg">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-4">
            <div class="flex items-center justify-between">
                <div class="flex items-center gap-3">
                    <img src="sigma_logo.png" alt="The Stoic Journey Logo" class="h-10 w-10 object-contain">
                    <span class="text-lg md:text-xl font-cinzel font-bold text-amber-400 tracking-wide">The Stoic Journey</span>
                </div>

                <div class="flex items-center gap-3 md:gap-4">
                    <!-- Streak -->
                    <div class="hidden sm:flex items-center gap-2 bg-gradient-to-r from-amber-500 to-orange-500 px-4 py-2 rounded-full streak-glow">
                        <span class="font-bold text-slate-900 text-lg" id="headerStreak">0</span>
                        <span class="text-xs text-slate-900 font-medium" data-i18n="dashboard.headerDays">giorni</span>
                    </div>

                    <!-- Lang switcher -->
                    <div class="flex items-center gap-1">
                        <button id="btnLangIT" class="lang-btn active text-xs font-semibold px-2.5 py-1 rounded border bg-transparent">IT</button>
                        <button id="btnLangEN" class="lang-btn text-xs font-semibold px-2.5 py-1 rounded border bg-transparent">EN</button>
                    </div>

                    <!-- User + logout -->
                    <div class="flex items-center gap-3">
                        <span class="hidden md:inline text-sm text-slate-300">
                            <span data-i18n="dashboard.greeting">Ciao,</span>
                            <span id="userName" class="font-semibold text-amber-400 ml-1">...</span>
                        </span>
                        <button id="logoutBtn" class="bg-slate-800 hover:bg-slate-700 text-amber-400 px-4 py-2 rounded-lg transition-all text-sm font-medium mobile-btn" data-i18n="dashboard.logout">
                            Esci
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </header>

    <div class="flex">
        <!-- SIDEBAR DESKTOP -->
        <aside class="hidden md:block w-64 bg-slate-900/95 backdrop-blur-sm border-r border-amber-500/20 min-h-screen sticky top-[73px] self-start">
            <nav class="p-6 space-y-2">
                <a href="dashboard.html" class="nav-link text-slate-300 hover:text-amber-400 transition-colors">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"/></svg>
                    <span data-i18n="dashboard.navToday">Oggi</span>
                </a>
                <a href="archivio.html" class="nav-link active transition-colors">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 8h14M5 8a2 2 0 110-4h14a2 2 0 110 4M5 8v10a2 2 0 002 2h10a2 2 0 002-2V8m-9 4h4"/></svg>
                    <span data-i18n="dashboard.navArchive">Archivio</span>
                </a>
                <a href="impostazioni.html" class="nav-link text-slate-300 hover:text-amber-400 transition-colors">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"/><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/></svg>
                    <span data-i18n="dashboard.navSettings">Impostazioni</span>
                </a>
            </nav>
        </aside>

        <!-- MAIN CONTENT -->
        <main class="flex-1 p-4 md:p-8 max-w-4xl mx-auto w-full">

            <!-- FILTRI -->
            <div class="parchment-card rounded-lg p-6 md:p-8 mb-6">
                <h3 class="text-xl md:text-2xl font-cinzel font-bold mb-6 uppercase tracking-wide flex items-center gap-2">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/></svg>
                    <span data-i18n="archive.filtersTitle">Filtri e Ricerca</span>
                </h3>
                <div class="space-y-4">
                    <div class="flex items-center gap-2">
                        <input
                            type="text"
                            id="searchInput"
                            data-i18n-placeholder="archive.searchPlaceholder"
                            placeholder="Cerca nelle riflessioni..."
                            class="parchment-input flex-1 px-4 py-3 rounded-lg font-medium transition-all"
                        >
                        <button id="toggleFilters" class="bg-slate-700 hover:bg-slate-600 text-white px-4 py-3 rounded-lg text-sm md:text-base font-bold transition-all mobile-btn" data-i18n="archive.filtersBtn">
                            Filtri
                        </button>
                    </div>

                    <div id="advancedFilters" class="hidden grid grid-cols-1 md:grid-cols-3 gap-3">
                        <input type="date" id="dateFrom" class="parchment-input px-4 py-3 rounded-lg font-medium">
                        <input type="date" id="dateTo" class="parchment-input px-4 py-3 rounded-lg font-medium">
                        <select id="contentTypeFilter" class="parchment-input px-4 py-3 rounded-lg font-medium">
                            <option value="" data-i18n="archive.allTypes">Tutti i tipi</option>
                            <option value="tipo1">Tipo 1</option>
                            <option value="tipo2">Tipo 2</option>
                            <option value="tipo3">Tipo 3</option>
                            <option value="tipo4">Tipo 4</option>
                        </select>
                    </div>

                    <button id="applyFilters" class="hidden w-full bg-gradient-to-r from-amber-600 to-orange-600 hover:from-amber-700 hover:to-orange-700 text-white px-6 py-3 rounded-lg transition-all font-bold text-sm mobile-btn" data-i18n="archive.applyFilters">
                        Applica Filtri
                    </button>
                </div>
            </div>

            <!-- STATISTICHE -->
            <div class="parchment-card rounded-lg p-6 md:p-8 mb-6">
                <h3 class="text-xl md:text-2xl font-cinzel font-bold mb-6 uppercase tracking-wide flex items-center gap-2">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"/></svg>
                    <span data-i18n="archive.statsTitle">Statistiche</span>
                </h3>
                <div class="grid grid-cols-2 gap-4 md:gap-6">
                    <div class="text-center">
                        <p class="text-4xl md:text-5xl font-bold text-amber-700 roman-number mb-2" id="totalReflections">0</p>
                        <p class="text-sm md:text-base text-amber-900 font-semibold" data-i18n="archive.totalReflections">Riflessioni Totali</p>
                    </div>
                    <div class="text-center">
                        <p class="text-base md:text-lg font-bold text-amber-900 mb-2" id="dateRange">-</p>
                        <p class="text-sm md:text-base text-amber-900 font-semibold" data-i18n="archive.period">Periodo</p>
                    </div>
                </div>
            </div>

            <!-- LISTA RIFLESSIONI -->
            <div id="reflectionsContainer" class="space-y-4 md:space-y-5"></div>

            <!-- PAGINAZIONE -->
            <div id="paginationControls" class="mt-6 md:mt-8 flex justify-center items-center gap-3 md:gap-4 flex-wrap pb-20 md:pb-8">
                <button id="prevPage" class="bg-slate-700 hover:bg-slate-600 text-white px-4 py-2.5 md:px-6 md:py-3 rounded-lg disabled:opacity-50 text-sm md:text-base font-bold transition-all" data-i18n="archive.prevPage">
                    ← Precedente
                </button>
                <span id="pageInfo" class="text-white font-bold text-sm md:text-base px-4 py-2 bg-slate-800/70 rounded-lg">Pag 1 di 1</span>
                <button id="nextPage" class="bg-slate-700 hover:bg-slate-600 text-white px-4 py-2.5 md:px-6 md:py-3 rounded-lg disabled:opacity-50 text-sm md:text-base font-bold transition-all" data-i18n="archive.nextPage">
                    Successiva →
                </button>
            </div>
        </main>
    </div>

    <!-- MOBILE BOTTOM NAVIGATION -->
    <nav class="md:hidden fixed bottom-0 left-0 right-0 bg-slate-900/95 backdrop-blur-sm border-t border-amber-500/20 z-40">
        <div class="flex justify-around py-2">
            <a href="dashboard.html" class="flex flex-col items-center gap-1 px-3 py-2 text-slate-300 hover:text-amber-400 transition-colors">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"/></svg>
                <span class="text-xs" data-i18n="dashboard.navToday">Oggi</span>
            </a>
            <a href="archivio.html" class="flex flex-col items-center gap-1 px-3 py-2 bg-amber-500/20 text-amber-400 font-medium rounded-lg">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 8h14M5 8a2 2 0 110-4h14a2 2 0 110 4M5 8v10a2 2 0 002 2h10a2 2 0 002-2V8m-9 4h4"/></svg>
                <span class="text-xs" data-i18n="dashboard.navArchive">Archivio</span>
            </a>
            <a href="impostazioni.html" class="flex flex-col items-center gap-1 px-3 py-2 text-slate-300 hover:text-amber-400 transition-colors">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"/><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/></svg>
                <span class="text-xs" data-i18n="dashboard.navSettings">Impostazioni</span>
            </a>
        </div>
    </nav>

    <!-- MODAL MODIFICA -->
    <div id="editModal" class="hidden fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4">
        <div class="bg-white rounded-xl p-5 md:p-8 max-w-3xl w-full max-h-[90vh] overflow-y-auto shadow-2xl">
            <h3 class="text-xl md:text-2xl font-cinzel font-bold mb-4 text-amber-900 uppercase tracking-wide" data-i18n="archive.editTitle">Modifica Riflessione</h3>
            <textarea
                id="editTextarea"
                data-i18n-placeholder="archive.editPlaceholder"
                placeholder="Modifica il testo della tua riflessione..."
                class="parchment-input w-full h-56 md:h-72 p-4 md:p-5 rounded-lg text-sm md:text-base font-medium"
                style="font-family: 'EB Garamond', serif;"
            ></textarea>
            <div class="mt-5 flex gap-3 md:gap-4">
                <button id="saveEditBtn" class="flex-1 bg-gradient-to-r from-amber-600 to-orange-600 hover:from-amber-700 hover:to-orange-700 text-white px-6 py-3 rounded-lg font-bold text-sm mobile-btn transition-all" data-i18n="archive.saveEdit">
                    Salva Modifiche
                </button>
                <button id="cancelEditBtn" class="flex-1 bg-slate-700 hover:bg-slate-600 text-white px-6 py-3 rounded-lg font-bold text-sm mobile-btn transition-all" data-i18n="archive.cancel">
                    Annulla
                </button>
            </div>
        </div>
    </div>

    <!-- TOAST -->
    <div id="toast" class="fixed bottom-6 right-6 bg-slate-800 border border-amber-500 text-amber-400 px-6 py-3 rounded-lg shadow-2xl transform translate-y-32 transition-transform duration-300 z-50 max-w-sm">
        <p id="toastMessage" class="text-sm font-medium"></p>
    </div>

    <!-- ========== SCRIPTS — ORDINE CRITICO ========== -->
    <script src="language-manager.js"></script>
    <script>
(function() {
    'use strict';

    const SUPABASE_URL = 'https://fayuadwpchhrxafbdntw.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZheXVhZHdwY2hocnhhZmJkbnR3Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjUxMTY3NDksImV4cCI6MjA4MDY5Mjc0OX0._D_c4Q0NFFSRfwiMKbrbqcrSbGDYfUSQ6BqjKjhauRE';
    const sbClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    let currentUser = null;
    let allReflections = [];
    let filteredReflections = [];
    let currentPage = 1;
    const ITEMS_PER_PAGE = 10;

    document.addEventListener('DOMContentLoaded', initArchive);

    async function initArchive() {
        const { data: { session }, error } = await sbClient.auth.getSession();
        if (!session) { window.location.href = 'accedi.html'; return; }
        currentUser = session.user;
        await loadUserData();
        await loadReflections();
        await loadProgressData();
        setupEventListeners();

        // Re-applica traduzioni dopo caricamento dati
        setTimeout(() => {
            const lang = localStorage.getItem('preferredLanguage') || 'it';
            if (lang !== 'it' && window.applyTranslations) window.applyTranslations(lang);
        }, 200);
    }

    async function loadUserData() {
        try {
            const { data: profile } = await sbClient.from('profiles').select('name').eq('id', currentUser.id).single();
            const displayName = profile?.name || currentUser.user_metadata?.full_name || currentUser.user_metadata?.name || currentUser.email?.split('@')[0] || 'Stoico';
            const el = document.getElementById('userName');
            if (el) el.textContent = displayName;
        } catch (err) {
            const el = document.getElementById('userName');
            if (el) el.textContent = currentUser.email?.split('@')[0] || 'Stoico';
        }
    }

    async function loadProgressData() {
        try {
            const { data: reflections } = await sbClient.from('reflections').select('date').eq('user_id', currentUser.id).order('date', { ascending: false });
            document.getElementById('headerStreak').textContent = calculateStreak(reflections);
        } catch (error) { console.error('Errore caricamento progresso:', error); }
    }

    function calculateStreak(reflections) {
        if (!reflections || reflections.length === 0) return 0;
        const today = new Date().toISOString().split('T')[0];
        const yesterday = new Date(Date.now() - 86400000).toISOString().split('T')[0];
        const uniqueDates = [...new Set(reflections.map(r => r.date))].sort().reverse();
        if (uniqueDates[0] !== today && uniqueDates[0] !== yesterday) return 0;
        let streak = 0;
        let currentDate = uniqueDates[0] === today ? new Date() : new Date(Date.now() - 86400000);
        for (const dateStr of uniqueDates) {
            const refDate = new Date(dateStr);
            const expectedDate = new Date(currentDate);
            expectedDate.setHours(0,0,0,0); refDate.setHours(0,0,0,0);
            if (refDate.getTime() === expectedDate.getTime()) { streak++; currentDate = new Date(currentDate.getTime() - 86400000); }
            else break;
        }
        return streak;
    }

    async function loadReflections(filters = {}) {
        try {
            let query = sbClient.from('reflections').select('*').eq('user_id', currentUser.id).order('date', { ascending: false });
            if (filters.dateFrom) query = query.gte('date', filters.dateFrom);
            if (filters.dateTo)   query = query.lte('date', filters.dateTo);
            if (filters.search)   query = query.ilike('content', `%${filters.search}%`);
            if (filters.contentType) query = query.eq('content_type', filters.contentType);
            const { data, error } = await query;
            if (error) throw error;
            allReflections = data || [];
            filteredReflections = allReflections;
            currentPage = 1;
            renderReflections();
            updateStatistics();
        } catch (error) {
            console.error('Errore:', error);
            showToast(getLang('archive.errorLoad', 'Errore caricamento riflessioni'));
        }
    }

    function getLang(key, fallback) {
        const lang = localStorage.getItem('preferredLanguage') || 'it';
        return window.TRANSLATIONS?.[lang]?.archive?.[key.split('.')[1]] || fallback;
    }

    function renderReflections() {
        const container = document.getElementById('reflectionsContainer');
        const lang = localStorage.getItem('preferredLanguage') || 'it';

        if (filteredReflections.length === 0) {
            const noFound   = lang === 'en' ? 'No reflections found' : 'Nessuna riflessione trovata';
            const startMsg  = lang === 'en' ? 'Start writing your daily reflections!' : 'Inizia a scrivere le tue riflessioni quotidiane!';
            container.innerHTML = `<div class="parchment-card rounded-lg p-8 md:p-12 text-center"><p class="text-lg md:text-xl text-amber-900 font-semibold">${noFound}</p><p class="text-sm md:text-base text-amber-800 mt-2">${startMsg}</p></div>`;
            updatePaginationControls(0);
            return;
        }
        const start = (currentPage - 1) * ITEMS_PER_PAGE;
        const paginatedItems = filteredReflections.slice(start, start + ITEMS_PER_PAGE);
        container.innerHTML = paginatedItems.map(r => renderReflectionCard(r, lang)).join('');
        updatePaginationControls(filteredReflections.length);
    }

    function renderReflectionCard(reflection, lang) {
        const dayRoman   = arabicToRoman(getDayOfYear(reflection.date));
        const dateFormatted = formatDate(reflection.date);
        const contentPreview = truncateText(reflection.content, 200);
        const editLabel  = lang === 'en' ? 'Edit'   : 'Modifica';
        const deleteLabel= lang === 'en' ? 'Delete' : 'Elimina';
        return `
            <div class="parchment-card rounded-lg p-5 md:p-7 transition-all hover:shadow-lg" data-id="${reflection.id}">
                <div class="flex flex-wrap justify-between items-start mb-4 gap-3">
                    <div class="flex items-center gap-3">
                        <span class="roman-number text-2xl md:text-3xl font-bold text-amber-700">${dayRoman}</span>
                        <span class="text-sm md:text-base text-amber-900 font-semibold">${dateFormatted}</span>
                    </div>
                </div>
                <div class="mb-4 md:mb-5">
                    <p class="text-amber-900 text-base md:text-lg leading-relaxed" style="font-family:'EB Garamond',serif;">${contentPreview}</p>
                </div>
                <div class="flex gap-3">
                    <button onclick="window.archiveApp.editReflection('${reflection.id}')" class="bg-gradient-to-r from-amber-600 to-orange-600 hover:from-amber-700 hover:to-orange-700 text-white px-4 py-2.5 md:px-5 md:py-3 rounded-lg text-sm md:text-base font-bold mobile-btn transition-all">${editLabel}</button>
                    <button onclick="window.archiveApp.deleteReflection('${reflection.id}')" class="bg-slate-700 hover:bg-slate-600 text-white px-4 py-2.5 md:px-5 md:py-3 rounded-lg text-sm md:text-base font-bold mobile-btn transition-all">${deleteLabel}</button>
                </div>
            </div>`;
    }

    async function deleteReflection(reflectionId) {
        const lang = localStorage.getItem('preferredLanguage') || 'it';
        const msg = lang === 'en' ? 'Are you sure you want to delete this reflection?' : 'Sei sicuro di voler eliminare questa riflessione?';
        if (!confirm(msg)) return;
        try {
            const { error } = await sbClient.from('reflections').delete().eq('id', reflectionId).eq('user_id', currentUser.id);
            if (error) throw error;
            showToast(lang === 'en' ? '✅ Reflection deleted!' : '✅ Riflessione eliminata con successo!');
            await loadReflections();
            await loadProgressData();
        } catch (error) {
            showToast(lang === 'en' ? '❌ Error deleting' : '❌ Errore durante l\'eliminazione');
        }
    }

    async function editReflection(reflectionId) {
        try {
            const { data, error } = await sbClient.from('reflections').select('content').eq('id', reflectionId).eq('user_id', currentUser.id).single();
            if (error) throw error;
            const modal = document.getElementById('editModal');
            const textarea = document.getElementById('editTextarea');
            textarea.value = data.content;
            modal.classList.remove('hidden');
            textarea.dataset.reflectionId = reflectionId;
        } catch (error) {
            const lang = localStorage.getItem('preferredLanguage') || 'it';
            showToast(lang === 'en' ? '❌ Error loading reflection' : '❌ Errore nel caricamento della riflessione');
        }
    }

    async function saveReflectionEdit() {
        const textarea = document.getElementById('editTextarea');
        const reflectionId = textarea.dataset.reflectionId;
        const newContent = textarea.value.trim();
        const lang = localStorage.getItem('preferredLanguage') || 'it';
        if (!newContent) { showToast(lang === 'en' ? '⚠️ Content cannot be empty' : '⚠️ Il contenuto non può essere vuoto'); return; }
        try {
            const { error } = await sbClient.from('reflections').update({ content: newContent }).eq('id', reflectionId).eq('user_id', currentUser.id);
            if (error) throw error;
            showToast(lang === 'en' ? '✅ Reflection updated!' : '✅ Riflessione aggiornata con successo!');
            closeEditModal();
            await loadReflections();
        } catch (error) {
            showToast(lang === 'en' ? '❌ Error saving' : '❌ Errore durante il salvataggio');
        }
    }

    function applyFilters() {
        loadReflections({
            search: document.getElementById('searchInput').value.trim(),
            dateFrom: document.getElementById('dateFrom').value,
            dateTo: document.getElementById('dateTo').value,
            contentType: document.getElementById('contentTypeFilter').value
        });
    }

    function updatePaginationControls(totalItems) {
        const totalPages = Math.ceil(totalItems / ITEMS_PER_PAGE);
        const lang = localStorage.getItem('preferredLanguage') || 'it';
        document.getElementById('prevPage').disabled = currentPage === 1;
        document.getElementById('nextPage').disabled = currentPage >= totalPages || totalPages === 0;
        const pageLabel = lang === 'en' ? `Page ${currentPage} of ${totalPages || 1}` : `Pag ${currentPage} di ${totalPages || 1}`;
        document.getElementById('pageInfo').textContent = pageLabel;
    }

    function goToPreviousPage() {
        if (currentPage > 1) { currentPage--; renderReflections(); window.scrollTo({ top: 0, behavior: 'smooth' }); }
    }

    function goToNextPage() {
        if (currentPage < Math.ceil(filteredReflections.length / ITEMS_PER_PAGE)) { currentPage++; renderReflections(); window.scrollTo({ top: 0, behavior: 'smooth' }); }
    }

    function updateStatistics() {
        document.getElementById('totalReflections').textContent = filteredReflections.length;
        if (filteredReflections.length > 0) {
            const dates = filteredReflections.map(r => new Date(r.date)).sort((a,b) => a-b);
            document.getElementById('dateRange').innerHTML = `${formatDate(dates[0].toISOString().split('T')[0])} - ${formatDate(dates[dates.length-1].toISOString().split('T')[0])}`;
        } else {
            document.getElementById('dateRange').textContent = '-';
        }
    }

    function getDayOfYear(dateString) {
        const date = new Date(dateString);
        return Math.floor((date - new Date(date.getFullYear(), 0, 0)) / 86400000);
    }

    function arabicToRoman(num) {
        const val = [1000,900,500,400,100,90,50,40,10,9,5,4,1];
        const syms = ['M','CM','D','CD','C','XC','L','XL','X','IX','V','IV','I'];
        let roman = '';
        for (let i = 0; i < val.length; i++) { while (num >= val[i]) { roman += syms[i]; num -= val[i]; } }
        return roman;
    }

    function formatDate(dateString) {
        const date = new Date(dateString);
        return `${String(date.getDate()).padStart(2,'0')}/${String(date.getMonth()+1).padStart(2,'0')}/${String(date.getFullYear()).slice(-2)}`;
    }

    function truncateText(text, maxLength) {
        return text.length <= maxLength ? text : text.slice(0, maxLength) + '...';
    }

    function showToast(message) {
        const toast = document.getElementById('toast');
        const toastMessage = document.getElementById('toastMessage');
        toastMessage.textContent = message;
        toast.style.transform = 'translateY(0)';
        setTimeout(() => { toast.style.transform = 'translateY(8rem)'; }, 4000);
    }

    function closeEditModal() { document.getElementById('editModal').classList.add('hidden'); }

    function setupEventListeners() {
        document.getElementById('toggleFilters').addEventListener('click', () => {
            document.getElementById('advancedFilters').classList.toggle('hidden');
            document.getElementById('applyFilters').classList.toggle('hidden');
        });
        document.getElementById('searchInput').addEventListener('input', (e) => {
            if (e.target.value.length > 2 || e.target.value.length === 0) applyFilters();
        });
        document.getElementById('applyFilters').addEventListener('click', applyFilters);
        document.getElementById('prevPage').addEventListener('click', goToPreviousPage);
        document.getElementById('nextPage').addEventListener('click', goToNextPage);
        document.getElementById('saveEditBtn').addEventListener('click', saveReflectionEdit);
        document.getElementById('cancelEditBtn').addEventListener('click', closeEditModal);
        document.getElementById('logoutBtn').addEventListener('click', async () => {
            await sbClient.auth.signOut();
            window.location.href = 'index.html';
        });
        document.getElementById('editModal').addEventListener('click', (e) => {
            if (e.target.id === 'editModal') closeEditModal();
        });
    }

    window.archiveApp = { editReflection, deleteReflection };
})();
    </script>
</body>
</html>

